
# hw definition file for processing by chibios_hwdef.py
# for My Toy Car Rover

# MCU class and specific type
MCU STM32F4xx STM32F405xx

# board ID for firmware load
APJ_BOARD_ID 1155

# crystal frequency, setup to use external oscillator
OSCILLATOR_HZ 8000000

FLASH_SIZE_KB 1024

# bootloader takes first sector
FLASH_RESERVE_START_KB 48

define HAL_STORAGE_SIZE 16384

STM32_ST_USE_TIMER 5



# GPIO output for active buzzer
# PB3 TIM2_CH2 TIM2 GPIO(80) LOW ALARM
PB3 BUZZER OUTPUT GPIO(80) LOW PULLDOWN
define HAL_BUZZER_PIN 80



# MOTORS PWM
PB8  TIM4_CH3  TIM4 PWM(1) GPIO(50)
PB4  TIM3_CH1  TIM3 PWM(2) GPIO(51)

# MOTORS relay
PC14  GPIO OUTPUT LOW GPIO(52)
PC15  GPIO OUTPUT LOW GPIO(53)
PC1   GPIO OUTPUT LOW GPIO(54)
PC3   GPIO OUTPUT LOW GPIO(55)



# SERIAL ports
SERIAL_ORDER OTG1 USART1 USART2 UART4 EMPTY EMPTY EMPTY
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1


# USART1 - MAVLink2 (companion computer)
PA10 USART1_RX USART1
PA9 USART1_TX USART1
define DEFAULT_SERIAL1_PROTOCOL SerialProtocol_MAVLink2


# USART2 - FlySky Telemetry (board pin head)
PA3 USART2_RX USART2
PA2 USART2_TX USART2
# Default is GHST protocol (TODO: Check defaults for FlySky PPM servo)
define DEFAULT_SERIAL2_PROTOCOL SerialProtocol_RCIN


# USART4 - JUST UART (board pin head)
PA1 UART4_RX UART4
PA0 UART4_TX UART4
define DEFAULT_SERIAL3_PROTOCOL SerialProtocol_None



# I2C ports
I2C_ORDER I2C1 I2C2
# I2C1
PB6 I2C1_SCL I2C1
PB7 I2C1_SDA I2C1
# I2C2 (board pin head)
PB10 I2C2_SCL I2C2
PB11 I2C2_SDA I2C2



# ADC ports
PC0 BATT_VOLTAGE_SENS ADC1 SCALE(1)
define HAL_BATT_VOLT_PIN 11
define HAL_BATT_VOLT_SCALE 5
PC2 BATT_CURRENT_SENS ADC1 SCALE(1)
define HAL_BATT_CURR_PIN 13
define HAL_BATT_CURR_SCALE 12
define AP_BATT_CURR_AMP_OFFSET_DEFAULT 2.5
define HAL_BATT_MONITOR_DEFAULT 4



# LED setup
PC4  LED_R OUTPUT HIGH GPIO(0)
PB0  LED_G OUTPUT HIGH GPIO(1)
PB2  LED_B OUTPUT HIGH GPIO(2)

define HAL_GPIO_A_LED_PIN 0
define HAL_GPIO_B_LED_PIN 1
define HAL_GPIO_C_LED_PIN 2



# Setup the pins for the microSD card, if available.
PC8 SDIO_D0 SDIO
PC9 SDIO_D1 SDIO
PC10 SDIO_D2 SDIO
PC11 SDIO_D3 SDIO
PC12 SDIO_CK SDIO
PD2 SDIO_CMD SDIO

define HAL_OS_FATFS_IO 1



# No OSD
define OSD_ENABLED 0
define OSD_PARAM_ENABLED 0



# SPI1 - GY-91 (MPU9250 + BMP280)
PA5 SPI1_SCK SPI1
PA6 SPI1_MISO SPI1
PA7 SPI1_MOSI SPI1
PC5 MPU_GYRO_CS CS
PB1 BARO_CS CS

# GY-91 gyro + baro
SPIDEV mpu9250  SPI1 DEVID1  MPU_GYRO_CS   MODE3  4*MHZ  8*MHZ
SPIDEV baro     SPI1 DEVID1  BARO_CS       MODE3  1*MHZ  8*MHZ

# GYRO setup
IMU Invensense SPI:mpu9250 ROTATION_ROLL_180_YAW_90
DMA_NOSHARE TIM2_UP TIM3_UP SPI1*
DMA_PRIORITY TIM2_UP TIM3_UP SPI1*

# BARO setup
BARO BMP280 SPI:baro
define HAL_BARO_ALLOW_INIT_NO_BARO 1
define AP_BARO_BACKEND_DEFAULT_ENABLED 0
define AP_BARO_BMP280_ENABLED 1



# COMPASS setup
define HAL_PERIPH_ENABLE_MAG
COMPASS QMC5883L I2C:0:0xd false ROTATION_ROLL_180_YAW_90
define HAL_COMPASS_MAX_SENSORS 1
# IRQ for compass
PB9 DRDY_QMC5883L INPUT PULLUP



include ../include/minimize_fpv_osd.inc
